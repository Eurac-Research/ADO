# Alpine Drought Observatory - AI Coding Agent Instructions

## Project Overview

Interactive drought monitoring dashboard for the Alpine region. Next.js 15 frontend with Mapbox visualization, fetching data from separate `ado-data` repository that's updated daily via GitHub Actions.

**Tech Stack:** Next.js 15 (App Router), React 19, TypeScript, Mapbox GL, ECharts, TailwindCSS, pnpm, Vercel

## Architecture & Data Flow

### Dual Repository Model
- **This repo (ADO)**: Frontend application
- **[ado-data](https://github.com/Eurac-Research/ado-data)**: Data storage with GitHub Actions processing
  - Daily updates: GeoJSON files, feature JSONs, metadata, TIFFs
  - Actions: Minification, feature extraction, TIFF colorization/optimization
  - Frontend fetches from: `raw.githubusercontent.com/Eurac-Research/ado-data/main`

### Hybrid Rendering Pattern
- **Server Components** (pages): Data fetching with `force-static` and `revalidate: false`
- **Client Components** (`*-client.tsx`): Interactivity, maps, charts
- Entry point: `app/page.tsx` → `app/drought-monitor/drought-monitor-client.tsx`

### Multi-Layer Caching Strategy (See `CACHING_IMPLEMENTATION.md`)
1. **Vercel Edge Cache**: Static pages with initial index (spei-1) pre-fetched
2. **Next.js Data Cache**: Server-side fetches with `next: { revalidate: false }`
3. **Client State Cache**: React Map for instant index switching (see `drought-monitor-client.tsx`)
4. **Browser HTTP Cache**: Client-side fetches use `cache: 'force-cache'`

**Key Optimization**: Base geometry (`nuts3_simple_4326.geojson`) fetched separately from feature data to avoid Next.js cache limits. Merged client-side in `mergeGeometryWithFeatures()`.

## Critical Conventions

### Drought Indices
- **Format**: lowercase with hyphens (e.g., `'spei-1'`, `'vhi'`)
- **In URLs/API**: UPPERCASE (e.g., `'SPEI-1'`, `'VHI'`)
- **Categories**: Defined in `lib/categories.ts` (precipitation, soil, vegetation, snow)
- **Available indices** (see `app/page.tsx`):
  ```typescript
  ['spei-1', 'spei-2', 'spei-3', 'spei-6', 'spei-12',
   'spi-1', 'spi-2', 'spi-3', 'spi-6', 'spi-12',
   'sspi-10', 'sma', 'vci', 'vhi']
  ```

### Data Fetching Patterns
**Always use `lib/data-fetcher.ts`** - centralized with consistent caching:
- `fetchDroughtIndexData()` - GeoJSON data
- `fetchDroughtIndexMetadata()` - Colormap metadata
- `fetchHydroData()` / `fetchHydroMetadata()` - Hydrological data
- Default: `revalidate: false` (cache until next build)
- Monthly revalidation: Use `monthlyRevalidationOptions`

### Path Aliases (tsconfig.json)
```typescript
'@/*' → root
'@/components/*' → './components/*'
'@/lib/*' → './lib/*'
'@/types/*' → './types/*'
```

### High-Res TIFF Rendering (See `HIGH_RES_TIFF_IMPLEMENTATION.md`)
- **Pre-processed in ado-data**: Colorization, COG optimization, PNG fallbacks
- **Client-side** (`lib/tiff-renderer.ts`): Only fetches + displays
- **URL pattern**: `tiffs/optimized/{index}/{year}/week-{week}.jpg`
- **Coordinate system**: Web Mercator (EPSG:3857) → WGS84 (EPSG:4326)

## Development Workflow

### Running Locally
```bash
pnpm install
pnpm dev          # Next.js dev server with Turbopack
pnpm build        # Production build
pnpm start        # Production server
```

### Adding a New Drought Index
1. **ado-data repo**: Add GeoJSON files + metadata JSON
2. **This repo**: Add index to `app/page.tsx` indices array
3. **Category**: Ensure index is covered in `lib/categories.ts`
4. Data files auto-generated by GitHub Actions in ado-data

### Branching Strategy
- Work in **`dev`** branch or feature branches
- PR to **`main`** (never commit directly to main)
- Vercel auto-deploys from main

## Key Files Reference

| File | Purpose |
|------|---------|
| `app/page.tsx` | Entry point, static generation config, initial data fetch |
| `app/drought-monitor/drought-monitor-client.tsx` | Main map interface, client-side caching logic |
| `lib/data-fetcher.ts` | Centralized data fetching with cache configs |
| `lib/tiff-renderer.ts` | High-res TIFF rendering with coordinate transformation |
| `lib/categories.ts` | Drought index categorization (precipitation/soil/vegetation/snow) |
| `components/ControlPanel.tsx` | Timeline slider, auto-play, forecast navigation |
| `components/HighResTiffLayer.tsx` | Mapbox image overlay for TIFFs |
| `CACHING_IMPLEMENTATION.md` | Detailed caching strategy documentation |
| `HIGH_RES_TIFF_IMPLEMENTATION.md` | TIFF processing pipeline documentation |

## Common Patterns

### Server Component Data Fetch
```typescript
export const dynamic = 'force-static'
export const revalidate = false

const data = await fetchDroughtIndexData('spei-1', defaultCacheOptions)
```

### Client Component with Cache
```typescript
'use client'

const [dataCache, setDataCache] = useState<Map<string, CachedData>>(
  () => new Map().set('spei-1', initialData)
)
```

### Index Switching
- Pre-fetch related indices on hover (see `prefetchRelatedIndices()`)
- Merge cached features with base geometry before rendering
- Update URL params: `router.push('/?index=spi-3', { scroll: false })`
